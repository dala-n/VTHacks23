<!DOCTYPE html>
<html>

{% include 'header.html' %}

<head>

</head>

<body>
    <div id="mapcover">
        <form id="geocode-form">
          <div class="tb">
            <div class="td">
                <input
                type="text"
                id="zipcode"
                name="zipcode"
                placeholder="Enter ZIP Code"
                required/>
            </div>
            <div class="td" id="s-cover">
              <button type="submit">
                <div id="s-circle"></div>
                <span></span>
              </button>
            </div>
          </div>
        </form>
      </div>

    <div class="info">
        <h1>My Google Map and Info Panel</h1>
        <div id="map-container">
            <div id="googleMap" style="height: 100%;"></div>
        </div>

        <!-- Create a container div for the info panel -->
        
        <div class="info-panel">
            <h2>Information Panel</h2>
 
            {% if data %}

            <h3>Pie Chart</h3>
            <img src="data:image/png;base64,{{ img_base64 }}" alt="Pie Chart">
        
            {% endif %}
        
            <!-- Include jQuery library for easier AJAX handling -->
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                // Handle the change event of the drop-down menu
                $('#data-type').change(function () {
                    // Submit the form asynchronously when the drop-down selection changes
                    $('#search-form').submit();
                });
            </script>
        
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            // Function to save the ZIP code to localStorage
            function saveZipCode() {
                const zipcode = $('#zipcode').val();
                localStorage.setItem('zipcode', zipcode);
            }
        
            // Function to load the ZIP code from localStorage and pre-fill the input field
            function loadZipCode() {
                const savedZipCode = localStorage.getItem('zipcode');
                if (savedZipCode) {
                    $('#zipcode').val(savedZipCode);
                }
            }
        
            // Handle the form submission
            $('#search-form').submit(function (event) {
                event.preventDefault();  // Prevent the default form submission
                saveZipCode();  // Save the ZIP code to localStorage
                const dataType = $('#data-type').val();  // Get the selected data type
                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: { zipcode: $('#zipcode').val(), 'data-type': dataType },  // Include both ZIP code and data type
                    success: function (response) {
                        $('body').html(response);  // Replace the entire body with the updated content
                        loadZipCode();  // Load the ZIP code from localStorage
                    }
                });
            });
        
            // Handle the change event of the drop-down menu
            $('#data-type').change(function () {
                // Submit the form asynchronously when the drop-down selection changes
                $('#search-form').submit();
            });
        
            // Load the ZIP code from localStorage when the page loads
            $(document).ready(function () {
                loadZipCode();
            });
        </script>

        </div>

    </div>

    <script>
        var map;
        function initMap() {
          map = new google.maps.Map(document.getElementById("googleMap"), {
            center: { lat: 0, lng: 0 }, // Initial center
            zoom: 5, // Initial zoom level
          });
  
          // Handle form submission for geocoding
          document
            .getElementById("geocode-form")
            .addEventListener("submit", function (event) {
              event.preventDefault();
              var zipcode = document.getElementById("zipcode").value;
  
              // Use the Geocoding API to convert ZIP code to coordinates
              var geocoder = new google.maps.Geocoder();
              geocoder.geocode(
                {
                  address: zipcode,
                },
                function (results, status) {
                  if (status === google.maps.GeocoderStatus.OK) {
                    var location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(13); // Adjust the zoom level as needed
                  } else {
                    alert(
                      "Geocode was not successful for the following reason: " +
                        status
                    );
                  }
                }
              );
            });
        }
      </script>
  
      <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_L6kO-aXyzkq3FpqMr3XzDiS0jTxbJYA&callback=initMap"></script>
    </body>
  </html>